<div class="container mt-5">
  <h2 class="mb-3"><%= @user.first_name %>'s Review Activity</h2>

  <% if @events.any? %>
    <% @events.each do |event| %>
      <% if event.assigned? && !event.read? %>
          <div id="event-<%= event.id %>" 
              class="alert alert-success alert-dismissible fade show" 
              role="alert">
              You are assigned as the client for <strong><%= event.listing.title %></strong> by <%= event.realtor.first_name %>. 
              You can now leave a review.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"
             data-event-id="<%= event.id %>"></button>
          </div>
      <% end %>
    <% end %>
  <% end %>


  <% if @events.any? %>
    <% @events.each do |event| %>
      <div class="card mb-3">
        <div class="card-body">
          <% if event.assigned? %>
              <p>
                You are assigned as the client for for <a class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="<%= listing_path(event.listing_id) %>"><strong><%= event.listing.title %></strong></a>
                on <%= event.created_at.strftime("%B %d, %Y %I:%M %p") %>
              </p>
          <% elsif event.review? %>
            <div class="card-body d-flex align-items-center">
              <div>
                <p>
                  You left a review for
                  <a class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="<%= user_path(event.realtor_id) %>"><strong><%= event.realtor.first_name %></strong></a> on
                  <%= event.created_at.strftime("%B %d, %Y %I:%M %p") %>
                </p>

                  <% knowledge = event.review.knowledge_rating.to_i %>
                  <p><strong>Knowledge & Expertise:</strong> <%= '★' * knowledge + '☆' * (5 - knowledge) %></p>

                  <% responsiveness = event.review.responsiveness_rating.to_i %>
                  <p><strong>Responsiveness:</strong> <%= '★' * responsiveness + '☆' * (5 - responsiveness) %></p>

                  <% professionalism = event.review.professionalism_rating.to_i %>
                  <p><strong>Professionalism:</strong> <%= '★' * professionalism + '☆' * (5 - professionalism) %></p>

                  <p><%= event.review.comment %></p>
                  <% if event.client == current_user %>
                    <%= button_to "Delete",
                      listing_review_path(event.listing, event.review),
                      method: :delete,
                      data: { confirm: "Are you sure you want to delete this review?" },
                      class: "btn btn-sm btn-danger" %>
                 <% end %>
              </div>

              <div class="ms-auto">
                <% if event.listing.listing_photos.attached? %>
                  <%= link_to listing_path(event.listing_id), title: "View listing", data: { bs_toggle: "tooltip" } do %>
                    <%= image_tag event.listing.listing_photos.first, class: "rounded", size: "200x200" %>
                  <% end %>
                <% end %>
              </div> 
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if @reviews.empty? && @events.empty? %>
    <p>No review activity yet.</p>
  <% end %>

  </div>

  <%= paginate @reviews if @reviews.present? %>
  <%= paginate @events if @events.present? %>

</div>