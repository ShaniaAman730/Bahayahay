<br>

 <%= render partial: "/shared/admin_dashboard" %>

 <br>

<div class="p-5">
  <h2>All Users</h2>

  <!-- Total Users -->
  <p class="text-muted mb-3">
    Total Users: <strong><%= @users.total_count rescue @users.size %></strong>
  </p>

  <!-- Search Form -->
  <div class="mb-4">
    <%= form_with url: all_users_users_path, method: :get, local: true, class: "row g-2 align-items-center" do %>
      <div class="col-12 col-md-10">
        <%= text_field_tag :q, params[:q], placeholder: "Search users...", class: "form-control w-100" %>
      </div>

      <div class="col-12 col-md-1">
        <%= select_tag :user_type, options_for_select(User.user_types.keys.map { |t| [t.titleize, t] }, params[:user_type]), include_blank: "All Types", class: "form-select w-100" %>
      </div>

      <div class="col-12 col-md-1 d-grid">
        <%= submit_tag "Search", class: "btn btn-primary w-100" %>
      </div>
    <% end %>
  </div>

  <% if @users.any? %>
    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>ID</th>
          <th>User Type</th> 
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Contact No</th>
          <th>Company Name</th>
          <th>Created</th>
          <th>Actions</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% @users.each_with_index do |user, index| %>
          <tr>
            <td><%= (@users.offset_value || 0) + index + 1 %></td>
            <td><%= user.id %></td>
            <td>
              <%= user.user_type.titleize %>
              <% if user.user_type == "realtor" %>
                <% if user.admin_approved? %>
                  <span class="badge bg-success ms-2">A</span>
                <% else %>
                  <span class="badge bg-warning text-dark ms-2">P</span>
                <% end %>
              <% end %>
            </td>
            <td>
              <% if user.user_type == "realtor" %>
                <a href="#" 
                   class="text-primary realtor-info-link" 
                   data-bs-toggle="modal" 
                   data-bs-target="#realtorInfoModal"
                   data-user='<%= user.to_json(only: [:id, :first_name, :last_name, :email, :contact_no, :prc_no, :dhsud_no, :company_name, :address, :is_broker, :broker_name, :broker_prc_no, :gov_id_type, :gov_id_last_digits]) %>'>
                   <%= user.first_name %>
                </a>
              <% else %>
                <%= user.first_name %>
              <% end %>
          </td>
            <td><%= user.last_name %></td>
            <td><%= user.email %></td>
            <td><%= user.contact_no %></td>
            <td><%= user.company_name %></td>
            <td><%= user.created_at.strftime("%B %d, %Y %I:%M %p") %></td>
            <td>
              <%= link_to "Show", user_path(user), class: "btn btn-sm btn-secondary me-1" %>
            </td>
            <td>
              <%= button_to "Delete", user_path(user), method: :delete, data: { confirm: "Are you sure you want to delete #{user.full_name}?" }, class: "btn btn-sm btn-danger" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

 <!-- Realtor Info Modal -->
<div class="modal fade" id="realtorInfoModal" tabindex="-1" aria-labelledby="realtorInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="realtorInfoModalLabel">Realtor Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="realtorInfoContent">
        <!-- Dynamic content goes here -->
      </div>
    </div>
  </div>
</div>
   



    <div class="mt-3">
      <%= paginate @users %>
    </div>
  <% else %>
    <p>No users found.</p>
  <% end %>
</div>


<script>
  document.addEventListener("turbo:load", () => {
    const modal = document.getElementById("realtorInfoModal");
    const content = document.getElementById("realtorInfoContent");

    document.querySelectorAll(".realtor-info-link").forEach(link => {
      link.addEventListener("click", (e) => {
        const user = JSON.parse(e.currentTarget.dataset.user);

        content.innerHTML = `
          <div class="row mt-2">
            <div class="col-12 col-md-4"><strong>First Name:</strong> ${user.first_name}</div>
            <div class="col-12 col-md-4"><strong>Last Name:</strong> ${user.last_name}</div>
            <div class="col-12 col-md-4"><p class="bg-warning text-black d-inline-block p-1 rounded"><strong>User ID:</strong> ${user.id}</p></div>
          </div>

          <div class="row mt-3">
            <div class="col-12"><strong>Email:</strong> ${user.email}</div>
            <div class="col-12"><strong>Contact no.:</strong> ${user.contact_no}</div>
            <div class="col-12"><strong>PRC ID or Accreditation number:</strong> ${user.prc_no || ''}</div>
            <div class="col-12"><strong>DHSUD Certificate number:</strong> ${user.dhsud_no || ''}</div>
            <div class="col-12"><strong>Realty:</strong> ${user.company_name || ''}</div>
            <div class="col-12"><strong>Realty/Company Address:</strong> ${user.address || ''}</div>
          </div>

          <div class="row mt-3">
            <div class="col-12"><strong>Is user a broker?</strong> ${user.is_broker ? 'Yes' : 'No'}</div>
            ${!user.is_broker ? `
              <div class="col-12"><strong>Broker Name:</strong> ${user.broker_name || ''}</div>
              <div class="col-12"><strong>Broker PRC ID No.:</strong> ${user.broker_prc_no || ''}</div>
            ` : ''}
          </div>

          <div class="row mt-3">
            <div class="col-12"><strong>Government ID Type:</strong> ${user.gov_id_type || ''}</div>
            <div class="col-12"><strong>Last Digits of Gov ID:</strong> ${user.gov_id_last_digits || ''}</div>
          </div>
        `;
      });
    });
  });
</script>
