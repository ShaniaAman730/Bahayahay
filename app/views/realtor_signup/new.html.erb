<br>
<div class="container mt-3">

    <h2>Realtor Sign-up</h2>

    <div class="alert alert-light small my-4" role="alert">
      <h6>Registration Guidelines</h6>
      <ul>
        <li><strong>Fill out all required fields</strong> before submitting the form.</li>

        <li>
          <strong>Upload the following documents</strong> for verification:
          <ul>
            <li>PRC I.D. or Accreditation</li>
            <li>DHSUD Certificate</li>
            <li>Government-issued I.D.</li>
          </ul>
        </li>

        <li>All submitted documents will be <strong>reviewed by the admin</strong> before granting you access to the system.</li>

        <li>
          <strong>If you are a salesperson:</strong>
          <ul>
            <li>Leave the <strong>“Are you a Licensed Real Estate Broker?”</strong> field <strong>unchecked</strong>.</li>
            <li>Your broker must have an <strong>existing account AND realty</strong> within the system before you can sign up.</li>
            <li>Enter your <strong>Broker’s Name</strong>, <strong>Broker’s PRC ID No.</strong>, or <strong>Realty Name</strong>. The system will automatically fill in related broker and realty details.</li>
          </ul>
        </li>

        <li>
          <strong>If you are a licensed broker:</strong>
          <ul>
            <li>You may enter <strong>“None”</strong> under <strong>Realty</strong> and <strong>Realty Address</strong> if these are not applicable.</li>
          </ul>
        </li>
   
        <li>You will receive an email from <strong><em>bahayahay.ph@gmail.com</em></strong> when your account is approved.</li>
      </ul>
    </div>

    <%= form_with model: @user, url: realtor_signup_index_path, local: true, html: { multipart: true } do |form| %>

    <div>
      <% if @user.errors.any? %>
        <div style="color: red">
          <h2><%= pluralize(@user.errors.count, "error") %> prohibited this account from being saved:</h2>                
          <ul>
            <% @user.errors.each do |error| %>
              <li><%= error.full_message %></li>
             <% end %>
          </ul>
        </div>
      <% end %>
    </div>

    <div class="form-row p-2">
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :first_name %>
        <%= form.text_field :first_name, required: true, class: "form-control", placeholder: "First name" %>
      </div>
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :last_name %>
        <%= form.text_field :last_name, required: true, class: "form-control", placeholder: "Last name" %>
      </div>
    </div>

    <div class="form-row p-2">
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :email %>
        <%= form.email_field :email, required: true, autofocus: true, autocomplete: "email", class: "form-control", placeholder: "Email" %>
      </div>
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :contact_no %>
        <%= form.text_field :contact_no, required: true, class: "form-control", placeholder: "Contact no." %>
      </div>
    </div>

    <div class="form-row p-2">
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :prc_no, "PRC ID or Accreditation number" %>
        <%= form.text_field :prc_no, required: true, class: "form-control", placeholder: "PRC ID or Accreditation number" %>
      </div>
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :prc_id, "Upload a picture of your PRC ID/Accreditation or your official PRC receipt" %>
        <%= form.file_field :prc_id, class: "form-control", class: "form-control", accept: "image/*", data: { max_size: 400.kilobytes }, required: true %>
      </div>
    </div>

    <div class="form-row p-2">
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :dhsud_no, "DHSUD Certificate number" %>
        <%= form.text_field :dhsud_no, required: true, class: "form-control", placeholder: "DHSUD Certificate number" %>
      </div>
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :dhsud_cert, "Upload a picture of your DHSUD Certificate" %>
        <%= form.file_field :dhsud_cert, class: "form-control", class: "form-control", accept: "image/*", data: { max_size: 400.kilobytes }, required: true %>
      </div>
    </div>

    <div class="field p-2 mb-3">
     <%= form.label :gov_id, "To verify your identity, please upload a picture of your government I.D." %>
     <%= form.file_field :gov_id, class: "form-control", class: "form-control", accept: "image/*", data: { max_size: 400.kilobytes }, required: true %>
    </div>

    <div class="form-row p-2">
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :is_broker, "Are you a Licensed Real Estate Broker?" %><br>
        <%= form.check_box :is_broker, {}, true, false %> Yes
      </div>
    </div>

    <div id="broker-fields" style="display:none;">
      <div class="form-row p-2">
        <div class="col-12 col-md-6 mb-3 position-relative">
           <%= form.label :broker_name, "Broker's Name" %>
          <%= form.text_field :broker_name, id: "broker-name", class: "form-control", placeholder: "Search broker..." %>
          <ul id="broker-suggestions" class="list-group position-absolute w-100" style="z-index:1000;"></ul>
        </div>

        <div class="col-12 col-md-6 mb-3 position-relative">
          <%= form.label :broker_prc_no, "Broker's PRC ID No." %>
          <%= form.text_field :broker_prc_no, id: "broker-prc-no", class: "form-control", placeholder: "Broker's PRC ID No." %>
          <ul id="broker-prc-no-suggestions" class="list-group position-absolute"></ul>
        </div>
      </div>
    </div>

    <div class="form-row p-2">
      <div class="col-12 col-md-6 mb-3 position-relative">
        <%= form.label :company_name, "Realty" %>
          <%= form.text_field :company_name, id: "realty-name", class: "form-control", placeholder: "Search realty..." %>
          <ul id="realty-suggestions" class="list-group position-absolute w-100" style="z-index:1000;"></ul>
      </div>
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :address, "Realty Address" %>
        <%= form.text_field :address, required: true, class: "form-control", placeholder: "Realty Address" %>
      </div>
    </div>

    <div class="form-check mb-3">
      <%= form.check_box :privacy_agreement, class: "form-check-input" %>
      <%= form.label :privacy_agreement, "I have read and agree to the Data Privacy Act of 2012 (RA 10173).", class: "form-check-label" %>
      <br>
      <small>
        You can read the full law here: 
        <a href="https://www.privacy.gov.ph/data-privacy-act/" target="_blank">Data Privacy Act (RA 10173)</a>
      </small>
    </div>

    <div class="form-row p-2">
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :password %>
        <% if @minimum_password_length %>
          <em>(<%= @minimum_password_length %> characters minimum)</em>
        <% end %><br />
        <%= form.password_field :password, required: true, autocomplete: "new-password", class: "form-control", placeholder: "Password" %>
      </div>
      <div class="col-12 col-md-6 mb-3">
        <%= form.label :password_confirmation %>
        <%= form.password_field :password_confirmation, required: true, autocomplete: "new-password", class: "form-control", placeholder: "Password" %>
      </div>
    </div>

    <div class="actions">
      <%= form.submit "Create Account", class: "btn btn-secondary", data: { confirm_privacy: true } %>
    </div>

  <% end %>
  <br>
</div>

<script>
  document.addEventListener("turbo:load", function() {
    const form = document.querySelector("form");
    const submitBtn = form?.querySelector("input[type='submit'][data-confirm-privacy]");

    if (submitBtn) {
      submitBtn.addEventListener("click", function(event) {
        const message = `By proceeding, you acknowledge and consent to the collection and processing of your personal data in accordance with the Data Privacy Act of 2012 (RA 10173).

Your personal information will be used solely for account verification, communication, and compliance with regulatory requirements. We will not share your data without your consent, except as required by law.

Do you agree to these terms?`;

        const agreed = confirm(message);
        if (!agreed) {
          event.preventDefault(); // stop form submission
        }
      }, { once: true }); // ensures the handler runs only once
    }
  });
</script>


<script>
(function() {
  function initRealtorAutocomplete() {
    // Prevent double initialization
    if (window.realtorSignupAutocompleteInitialized) return;
    window.realtorSignupAutocompleteInitialized = true;

    // Debounce helper
    function debounce(fn, delay) {
      let timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    function setupAutocomplete({inputId, suggestionId, url, displayField, fillCallback}) {
      const input = document.getElementById(inputId);
      const suggestions = document.getElementById(suggestionId);
      if (!input || !suggestions) return;

      input.addEventListener("input", debounce(function() {
        const query = this.value.trim();
        suggestions.innerHTML = "";

        if (query.length < 2) return;

        const loadingItem = document.createElement("li");
        loadingItem.textContent = "Loading...";
        loadingItem.className = "list-group-item";
        suggestions.appendChild(loadingItem);

        fetch(`${url}?q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            suggestions.innerHTML = "";
            if (!data.length) {
              const li = document.createElement("li");
              li.textContent = "No results found";
              li.className = "list-group-item disabled";
              suggestions.appendChild(li);
            } else {
              data.forEach(item => {
                const li = document.createElement("li");
                li.className = "list-group-item list-group-item-action autocomplete-item";
                li.textContent = item[displayField] || "";
                li.addEventListener("click", () => {
                  fillCallback(item);
                  suggestions.innerHTML = "";
                });
                suggestions.appendChild(li);
              });
            }
          })
          .catch(() => { suggestions.innerHTML = ""; });
      }, 100));

      // Hide suggestions when clicking outside
      document.addEventListener("click", (e) => {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.innerHTML = "";
        }
      });
    }

    // --- Broker Name ---
    setupAutocomplete({
      inputId: "broker-name",
      suggestionId: "broker-suggestions",
      url: "/realtor_signup/search_brokers",
      displayField: "name",
      fillCallback: (broker) => {
        document.getElementById("broker-name").value = broker.name;
        document.getElementById("broker-prc-no").value = broker.prc_no;
        document.getElementById("realty-name").value = broker.company_name || "";
        document.getElementById("user_address").value = broker.address || "";
      }
    });

    // --- Broker PRC No ---
    setupAutocomplete({
      inputId: "broker-prc-no",
      suggestionId: "broker-prc-no-suggestions",
      url: "/realtor_signup/search_broker_prc_no",
      displayField: "prc_no",
      fillCallback: (broker) => {
        document.getElementById("broker-prc-no").value = broker.prc_no;
        document.getElementById("broker-name").value = broker.name;
        document.getElementById("realty-name").value = broker.company_name || "";
        document.getElementById("user_address").value = broker.address || "";
      }
    });

    // --- Realty Name ---
    setupAutocomplete({
      inputId: "realty-name",
      suggestionId: "realty-suggestions",
      url: "/realtor_signup/search_realties",
      displayField: "company_name",
      fillCallback: (realty) => {
        document.getElementById("realty-name").value = realty.company_name;
        document.getElementById("user_address").value = realty.address || "";
        document.getElementById("broker-name").value = realty.broker_name || "";
        document.getElementById("broker-prc-no").value = realty.broker_prc_no || "";
      }
    });
  }

  // Run once DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initRealtorAutocomplete);
  } else {
    initRealtorAutocomplete();
  }

  // Also re-run on Turbo visits
  document.addEventListener("turbo:load", initRealtorAutocomplete);
})();
</script>


<style>
    /* Autocomplete items */
    .autocomplete-item {
      cursor: pointer;
    }

    .autocomplete-item:hover {
      background-color: #e9ecef;
    }

  .position-relative .list-group {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1050;
  }

</style>
