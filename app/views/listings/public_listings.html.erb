    <div class="shadow-sm p-4 mb-2 bg-white rounded">
    <%= form_with url: public_listings_path, method: :get, local: true, class: "row g-2 align-items-end" do %>
    <!-- First Row -->
    <div class="row g-2">
      <!-- Keyword -->
      <div class="col-12 col-md-3"> 
        <%= label_tag :keyword, "Search Properties", class: "form-label" %>
        <%= text_field_tag :keyword, params[:keyword], class: "form-control", placeholder: "Type a keyword..." %>
      </div>

      <!-- Barangay -->
      <div class="col-12 col-md-1">
        <%= label_tag :barangay, "Barangay", class: "form-label" %>
        <%= select_tag :barangay, options_for_select(Listing.barangays.keys.map { |brgy| [brgy.humanize, brgy] }, params[:barangay]), include_blank: "Any", class: "form-select" %>
      </div>

      <!-- Bedrooms -->
      <div class="col-6 col-md-1">
        <%= label_tag :beds, "Bedrooms", class: "form-label" %>
        <%= select_tag :beds, options_for_select([[1, 1], [2, 2], [3, 3], [4, 4], ['5+', 5]], params[:beds]), include_blank: "Any", class: "form-select" %>
      </div>

      <!-- Baths -->
      <div class="col-6 col-md-1">
        <%= label_tag :baths, "T&B", class: "form-label" %>
        <%= select_tag :baths, options_for_select([[1, 1], [2, 2], [3, 3], [4, 4], ['5+', 5]], params[:baths]), include_blank: "Any", class: "form-select" %>
      </div>

      <!-- Min Price -->
      <div class="col-6 col-md-1">
        <%= label_tag :min_price, "Min Price", class: "form-label" %>
        <%= select_tag :min_price, options_for_select([
          ['Any', ''], ['₱800k', 800_000], ['₱1M', 1_000_000], ['₱2M', 2_000_000],
          ['₱3M', 3_000_000], ['₱4M', 4_000_000], ['₱5M', 5_000_000]
        ], params[:min_price]), class: "form-select" %>
      </div>

      <!-- Max Price -->
      <div class="col-6 col-md-1">
        <%= label_tag :max_price, "Max Price", class: "form-label" %>
        <%= select_tag :max_price, options_for_select([
          ['Any', ''], ['₱1M', 1_000_000], ['₱2M', 2_000_000], ['₱3M', 3_000_000],
          ['₱4M', 4_000_000], ['₱5M', 5_000_000], ['₱6M+', 6_000_000]
        ], params[:max_price]), class: "form-select" %>
      </div>
    </div>

    <!-- Second Row -->
    <div class="row g-2 mt-2">
      <!-- Project Type -->
      <div class="col-6 col-md-1">
        <%= label_tag :project_type, "Project Type", class: "form-label" %>
        <%= select_tag :project_type, options_for_select(Listing.project_types.keys.map { |pt| [pt.humanize, pt] }, params[:project_type]), include_blank: "Any", class: "form-select" %>
      </div>

      <!-- Furnish Type -->
      <div class="col-6 col-md-1">
        <%= label_tag :furnish_type, "Furnish Type", class: "form-label" %>
        <%= select_tag :furnish_type, options_for_select(Listing.furnish_types.keys.map { |ft| [ft.humanize, ft] }, params[:furnish_type]), include_blank: "Any", class: "form-select" %>
      </div>

      <!-- Financing Options -->
      <div class="col-12 col-md-4 d-flex align-items-center p-1 mt-4 ml-2">
        <label class="form-label me-2 mb-0 fw-semibold ml-1">Financing Options:</label>
        <div class="form-check me-2">
          <%= check_box_tag :pagibig_financing, true, params[:pagibig_financing].present?, class: "form-check-input" %>
          <%= label_tag :pagibig_financing, "PAGIBIG", class: "form-check-label" %>
        </div>
        <div class="form-check me-2">
          <%= check_box_tag :bank_financing, true, params[:bank_financing].present?, class: "form-check-input" %>
          <%= label_tag :bank_financing, "Bank", class: "form-check-label" %>
        </div>
        <div class="form-check me-2">
          <%= check_box_tag :inhouse_financing, true, params[:inhouse_financing].present?, class: "form-check-input" %>
          <%= label_tag :inhouse_financing, "In-house", class: "form-check-label" %>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="col-12 col-md-2 mt-4">
        <%= submit_tag "Search", class: "btn btn-success w-100" %>
      </div>
    </div>
  <% end %>
  </div>

<div class="row mt-1">
<div class="col-12 col-md-6 col-lg-5 shadow bg-white rounded p-4">
  <% if @listings.any? %>
  <div class="row row-cols-1 row-cols-md-2 g-4">
    <% @listings.each do |listing| %>
      <div class="col">
          <div class="card h-100 position-relative">
            <% if listing.listing_photos.attached? %>
              <%= image_tag listing.listing_photos.first,
               class: "card-img-top fixed-img" %>

              <% if user_signed_in? && current_user.client? %>
              <% saved_listing = current_user.saved_listings.find_by(listing_id: listing.id) %>
              <div class="save-button position-absolute top-0 end-0 m-2" style="display:none;">
                  <% if saved_listing.present? %>
                <%= button_to saved_listing_path(saved_listing),
                  method: :delete,
                  class: "btn btn-success btn-sm d-flex align-items-center gap-1" do %>
                  <i class="bi bi-bookmarks-fill"></i>
                <% end %>
                <% else %>
                <%= button_to saved_listings_path(listing_id: listing.id),
                  method: :post,
                  class: "btn btn-outline-primary btn-sm d-flex align-items-center gap-1" do %>
                  <i class="bi bi-bookmarks"></i>
                <% end %>
              <% end %>
            </div>
              <% end %>
            <% else %>
              <img src="https://via.placeholder.com/400x300" class="card-img-top" alt="No image available">
            <% end %>

            <div class="card-body">
              <h5 class="card-title h-color mb-0">
                <%= link_to listing.title, listing_path(listing), class: "text-decoration-none text-dark" %>
              </h5>
              <p class="card-text">
                <i class="bi bi-geo-alt-fill"></i>
                <%= listing.address %>, <%= listing.barangay %>, Naga City
              </p>
              <h6 class="text-success"><strong><%= number_to_currency(listing.price, unit: "₱", precision: 2, delimiter: ",") %></strong></h6>

              <div class="d-flex flex-wrap mb-2">
                <span class="badge bg-light text-dark border me-2"><%= listing.beds %> Beds</span>
                <span class="badge bg-light text-dark border me-2"><%= listing.baths %> Baths</span>
                <span class="badge bg-light text-dark border"><%= listing.sqft %> Sq. ft.</span>
              </div>

              <p class="card-text"><%= truncate(listing.description&.to_plain_text || "", length: 80) %></p>
            </div>
          </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="alert alert-warning text-center mt-4">
    No properties found matching your search.
  </div>
<% end %>

<%= paginate @listings, class: "pagination justify-content-center mt-5" %>

</div>
  <div class="col-12 col-md-7">
    <div id="public-map" class="map-container"></div>
  </div>
</div>


<% content_for :hide_footer, true %>

<style>
  .card:hover .save-button {
    display: block !important;
  }

  .leaflet-popup-content-wrapper,
  .leaflet-popup-tip {
    pointer-events: auto;
  }

  #public-map {
    pointer-events: auto;
    z-index: 1; 
  }

</style>

<script>
  function initPublicMap() {
    const mapElement = document.getElementById("public-map");
    if (!mapElement) return;

    // Remove previous map if Leaflet already attached
    if (mapElement._leaflet_id) {
      mapElement._leaflet_id = null;
      mapElement.innerHTML = "";
    }

    let center = <%= raw @map_center.to_json %>;
    let map = L.map(mapElement).setView(center, 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    const listings = <%= raw @listings.to_json(
      only: [:id, :price, :beds, :baths, :latitude, :longitude],
      methods: [:first_photo_url]
    ) %>; 

    listings.forEach(listing => {

      if (!listing.latitude || !listing.longitude) {
        return; // skip listings without coords
      } else {

      let lat = listing.latitude || center[0];
      let lng = listing.longitude || center[1];

      let marker = L.marker([lat, lng], { 
        icon: L.icon({ 
          iconUrl: "<%= asset_path('green-pin.png') %>",
        }) 
      }).addTo(map);

      marker.on('click', function() {
        window.location.href = `/listings/${listing.id}`;
      });

      let popupContent = `
          <div style="width: 200px;">
            <img src="${listing.first_photo_url}" style="width: 100%; border-radius: 8px;" />
            <h6 class="mt-2">₱${Number(listing.price).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</h6>
            <p>${listing.beds} Beds • ${listing.baths} Baths</p>
          </div>
        </a>
      `;

      marker.bindPopup(popupContent);

      // Open popup on hover
      marker.on('mouseover', function() { this.openPopup(); });
      marker.on('mouseout', function() { this.closePopup(); })
    }
    });
  }

  // Run map on initial page load
  document.addEventListener("turbo:load", initPublicMap);

  // Also run map whenever Turbo replaces the listings content
  document.addEventListener("turbo:frame-load", initPublicMap);

  // Prevents map from not being draggable
  publicMap = L.map(mapElement, {
    dragging: true,
    tap: false,        
    scrollWheelZoom: true
  }).setView(center, 14);

</script>



