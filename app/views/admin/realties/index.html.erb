<br>

<%= render partial: "/shared/admin_dashboard" %>

<div class="p-5">
	<h2>Realties</h2>

	<!-- Total Realties -->
  <p class="text-muted mb-3">
    Total Realties: <strong><%= @realties.total_count rescue @realties.size %></strong>
  </p>

  <!-- Search Form -->
	<div class="mb-4">
  <%= form_with url: admin_realties_path, method: :get, local: true, 
                class: "row g-2 align-items-center" do %>

    <div class="col-12 col-md-10">
      <%= text_field_tag :q, params[:q], 
            placeholder: "Search realties...", 
            class: "form-control w-100" %>
    </div> 

    <div class="col-12 col-md-1">
      <%= select_tag :status, 
            options_for_select(Realty.statuses.keys.map { |s| [s.titleize, s] }, params[:status]), 
            include_blank: "All Statuses", 
            class: "form-select w-100" %>
    </div>

    <div class="col-12 col-md-1 d-grid">
      <%= submit_tag "Search", class: "btn btn-primary w-100" %>
    </div>
  <% end %>
</div>


  <% if @realties.any? %>
	<table class="table table-bordered">
	  <thead>
	    <tr>
	    	<th>#</th>
        <th>ID</th>
	      <th>Name</th>
	      <th>Broker</th>
	      <th>Email</th>
	      <th>Location</th>
	      <th>Status</th>
	      <th>Submitted</th>
	      <th>Actions</th>
	      <th></th>
	      <th></th>
	    </tr>
	  </thead>
	  <tbody>
	    <% @realties.each_with_index do |realty, index| %>
	      <tr>
					<td><%= (@realties.offset_value || 0) + index + 1 %></td>
          <td><%= realty.id %></td>
					<td>
					  <a href="#"
					     class="text-primary realty-info-link"
					     data-bs-toggle="modal"
					     data-bs-target="#realtyInfoModal"
					     data-realty='<%= realty.to_json(only: [:id, :name, :email, :business_location, :permit_type, :permit_last_digits], methods: [:head_broker_name]) %>'>
					     <%= realty.name %>
					  </a>
					</td>
	        <td><%= realty.head_broker.full_name %></td>
	        <td><%= realty.email %></td>
	        <td><%= realty.business_location %></td>
	        <td>
	        	<span class="badge 
				    <%= case realty.status
				        when "pending" then "badge-warning"
				        when "approved" then "badge-success"
				        when "rejected" then "badge-danger"
				        end %> text-black">
				    <%= realty.status.capitalize %>
	        </td>
	        <td><%= realty.created_at.to_date %></td>
	        <td>
	        	<%= link_to "View Application", admin_realty_path(realty), class: "btn btn-sm btn-light btn-sm" %>
	        	<% if realty.approved? %>
	        </td>
	        <td>
	        		<%= link_to "Show", realty_path(realty), class: "btn btn-sm btn-secondary btn-sm" %>
	        	<% end %>
	        </td>
	        <td>
	        	<%= button_to "Delete",
              admin_realty_path(realty),
              method: :delete,
              data: { confirm: "Are you sure you want to delete this realty?" },
              form: { class: "d-inline" },
              class: "btn btn-sm btn-danger ms-1" %>
	        </td>
	      </tr>
	    <% end %>
	  </tbody>
	</table>

	 <!-- Realty Info Modal -->
	<div class="modal fade" id="realtyInfoModal" tabindex="-1" aria-labelledby="realtyInfoModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-lg modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="realtyInfoModalLabel">Realty Information</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body" id="realtyInfoContent">
	        <!-- Dynamic content goes here -->
	      </div>
	    </div>
	  </div>
	</div>
	   

    <div class="mt-3">
      <%= paginate @realties %>
    </div>
  <% else %>
    <p>No realties found.</p>
  <% end %>
</div>

<script>
	document.addEventListener("turbo:load", () => {
	  const content = document.getElementById("realtyInfoContent");

	  document.querySelectorAll(".realty-info-link").forEach(link => {
	    link.addEventListener("click", (e) => {
	      const realty = JSON.parse(e.currentTarget.dataset.realty);

	      content.innerHTML = `
	        <div class="row mt-2">
	          <div class="col-12><strong>Realty ID:</strong> ${realty.id}</div>
	          <div class="col-12"><strong>Name:</strong> ${realty.name}</div>
	          <div class="col-12><strong>Email:</strong> ${realty.email || ''}</div>
	          <div class="col-12"><strong>Business Location:</strong> ${realty.business_location || ''}</div>
	          <div class="col-12"><strong>Head Broker:</strong> ${realty.head_broker_name || 'N/A'}</div>
	        </div>

	        <div class="row mt-2">
	          <div class="col-12"><strong>Permit type:</strong> ${realty.permit_type || ''}</div>
	      	<div class="col-12"><strong>Last 4 Digits of Permit:</strong> ${realty.permit_last_digits || ''}</div>
	        </div>
	      `;
	    });
	  });
	});
</script>
