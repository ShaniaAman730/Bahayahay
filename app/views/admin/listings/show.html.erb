<div class="container mt-5">
  <div class="listing-container">

    <h2>Independent Listing Requirements</h2>

    <div class="alert alert-warning">
      <strong>Previous reason for rejection (if applicable):</strong> 
      <%= "#{@listing.rejection_reason}" if @listing.rejection_reason.present? %>
      <br>
      <em><small>Note: This is left blank if the listing was not previously rejected and/or was simply updated by the realtor.</small></em>
    </div>

    <h5>Attachments Gallery</h5>
    <% if !@listing.spa.attached? && !@listing.tct.attached? && !@listing.valid_id.attached? && !@listing.birthcert.attached? %>
      <p>No attachments available</p>
    <% end %>
    <!-- Gallery -->
    <div class="d-flex flex-wrap gap-2 mb-4 mt-4">
      <div class="image-gallery d-flex flex-wrap gap-2">
        <% attachments = [] %>

        <% attachments << { file: @listing.valid_id, label: "Valid I.D." } if @listing.valid_id.attached? %>
        <% attachments << { file: @listing.birthcert, label: "Birth Certificate" } if @listing.birthcert.attached? %>

        <% if @listing.spa.attached? %>
          <% @listing.spa.each_with_index do |file, i| %>
            <% attachments << { file: file, label: "Special Power of Attorney (#{i + 1})" } %>
          <% end %>
        <% end %>

        <% if @listing.tct.attached? %>
          <% @listing.tct.each_with_index do |file, i| %>
            <% attachments << { file: file, label: "Transfer Certificate Title (#{i + 1})" } %>
          <% end %>
        <% end %>

        <% attachments.each_with_index do |item, index| %>
          <% file = item[:file] %>
          <% if file.content_type.start_with?("image/") %>
            <div style="flex: 0 0 auto;">
              <%= image_tag file,
                  class: "img-thumbnail media",
                  style: "width: 200px; height: 200px; object-fit: cover; cursor: pointer;",
                  data: { index: index + 1, description: item[:label] } %>
            </div>
          <% else %>
            <!-- fallback for non-image files -->
            <div style="flex: 0 0 auto; width: 200px; height: 200px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center;">
              <%= link_to item[:label], url_for(file), target: "_blank" %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>


      <!-- Modal -->
      <div id="galleryModal" class="modal" style="display:none; flex-direction:column; align-items:center;">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="modalCaption" style="margin-top:10px; color:white; text-align:center;"></div>
        <a class="prev" onclick="changeImage(-1)">&#10094;</a>
        <a class="next" onclick="changeImage(1)">&#10095;</a>
    </div>


    <h5>Extra Requirements</h5>
    <table class="table table-bordered">
      <tbody>
        <tr>
          <td><strong>Is the owner alive?</strong></td>
          <td><%= @listing.owneralive ? "Yes" : "No" %></td>
        </tr>
        <tr>
          <td><strong>Is the estate tax paid?</strong></td>
          <td><%= @listing.estatetax ? "Yes" : "No" %></td>
        </tr>
        <tr>
          <td><strong>Is extrajudicial settlement processed?</strong></td>
          <td><%= @listing.ejsprocessed ? "Yes" : "No" %></td>
        </tr>
        <tr>
          <td><strong>Is the owner a Filipino citizen?</strong></td>
          <td><%= @listing.filipinocitizen ? "Yes" : "No" %></td>
        </tr>

        <% unless @listing.filipinocitizen %>
          <tr>
            <td><strong>Citizenship:</strong></td>
            <td><%= @listing.citizenship&.humanize %></td>
          </tr>

          <% if @listing.valid_id.attached? %>
            <tr>
              <td><strong>Valid ID:</strong></td>
              <td><%= link_to "View", url_for(@listing.valid_id), target: "_blank" %></td>
            </tr>
          <% end %>

          <tr>
            <td><strong>TIN:</strong></td>
            <td><%= @listing.tin.presence || "N/A" %></td>
          </tr>

          <% if @listing.birthcert.attached? %>
            <tr>
              <td><strong>Birth Certificate:</strong></td>
              <td><%= link_to "View", url_for(@listing.birthcert), target: "_blank" %></td>
            </tr>
          <% end %>
        <% end %>

        <tr>
          <td><strong>Is the owner abroad?</strong></td>
          <td><%= @listing.ownerabroad ? "Yes" : "No" %></td>
        </tr>

        <% if @listing.ownerabroad %>
          <% if @listing.spa.attached? %>
            <tr>
              <td><strong>SPA Documents:</strong></td>
              <td>
                <ul class="mb-0">
                  <% @listing.spa.each do |doc| %>
                    <li><%= link_to doc.filename.to_s, url_for(doc), target: "_blank" %></li>
                  <% end %>
                </ul>
              </td>
            </tr>
          <% end %>

          <tr>
            <td><strong>Attorney-in-fact:</strong></td>
            <td><%= @listing.aif.presence || "N/A" %></td>
          </tr>
        <% end %>

        <% if @listing.tct.attached? %>
          <tr>
            <td><strong>Transfer Certificate of Title (TCT):</strong></td>
            <td>
              <ul class="mb-0">
                <% @listing.tct.each do |file| %>
                  <li><%= link_to file.filename.to_s, url_for(file), target: "_blank" %></li>
                <% end %>
              </ul>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>


    <%= form_with model: [:admin, @listing], url: reject_admin_listing_path(@listing), method: :patch, local: true do |f| %>
      <div class="mb-3">
        <h5>Reason for rejection (if applicable)</h5>
        <div class="d-flex">
          <%= f.radio_button :rejection_reason, "Missing requirements",
                class: "btn-check",
                id: "reason-missing",
                autocomplete: "off" %>
          <%= f.label :rejection_reason, "Missing requirements",
                class: "btn btn-outline-secondary me-2",
                for: "reason-missing" %>

          <%= f.radio_button :rejection_reason, "Contradicting answers",
                class: "btn-check",
                id: "reason-contradicting",
                autocomplete: "off" %>
          <%= f.label :rejection_reason, "Contradicting answers",
                class: "btn btn-outline-secondary me-2",
                for: "reason-contradicting" %>
        </div>


        <div class="mt-2">
          <%= f.label :custom_reason, "Custom reason (optional)" %>
          <%= f.text_area :custom_reason, rows: 4, class: "form-control" %>
        </div>
      </div>
      <%= f.submit "Reject", class: "btn btn-danger" %>
    <% end %>

    <%= button_to "Approve", approve_admin_listing_path(@listing), method: :patch, class: "btn btn-success mt-2" %>

    <br>

    <%= link_to "View Listing", listing_path(@listing) %><br>
    <a href="/admin/listings">Back to Listings Pending for Approval</a>

  <div class="mb-5"></div>
  <div class="mb-5"></div>
  </div>
</div>